#!/bin/bash

clear

# Check if gum and checkupdates are available
if ! command -v gum &>/dev/null; then
  echo "Error: gum not found"
  echo "Install with: sudo pacman -S gum"
  echo
  read -p "Press enter to close..."
  exit 1
fi

if ! command -v checkupdates &>/dev/null; then
  gum style --foreground 196 --bold "Error: checkupdates not found"
  echo "Install with: sudo pacman -S pacman-contrib"
  echo
  read -p "Press enter to close..."
  exit 1
fi

gum style --border double --border-foreground 39 --padding "1 2" --margin "1 0" --bold "System Update Check"

gum spin --spinner dot --title "Checking for updates..." -- sh -c 'checkupdates 2>/dev/null > /tmp/updates.tmp'

updates=$(cat /tmp/updates.tmp 2>/dev/null)
count=$(echo "$updates" | grep -c '[^[:space:]]' 2>/dev/null || echo "0")

if [ -z "$updates" ] || [ "$count" -eq 0 ]; then
  gum style --foreground 46 --bold "✓ System is up to date!"
  echo
  read -p "Press enter to close..."
  rm -f /tmp/updates.tmp
  exit 0
fi

gum style --foreground 226 --bold "$count package(s) available for update:"
echo
echo "$updates" | while read -r line; do
  [ -z "$line" ] && continue
  pkg=$(echo "$line" | awk '{print $1}')
  old_ver=$(echo "$line" | awk '{print $2}')
  new_ver=$(echo "$line" | awk '{print $4}')
  echo "  $(gum style --foreground 51 "$pkg") $(gum style --foreground 245 "$old_ver → $new_ver")"
done

echo
if gum confirm "Proceed with update?"; then
  echo
  gum style --foreground 39 --bold "Updating packages..."
  echo
  echo "$updates" | while read -r line; do
    [ -z "$line" ] && continue
    pkg=$(echo "$line" | awk '{print $1}')
    echo "  → $pkg"
  done
  echo
  
  sudo pacman -Syu
  
  echo
  gum style --foreground 46 --bold "✓ Update complete!"
  echo
  
  # Show what was updated
  gum style --foreground 39 --bold "Updated packages:"
  echo
  echo "$updates" | while read -r line; do
    [ -z "$line" ] && continue
    pkg=$(echo "$line" | awk '{print $1}')
    new_ver=$(echo "$line" | awk '{print $4}')
    echo "  $(gum style --foreground 46 "✓") $(gum style --foreground 51 "$pkg") $(gum style --foreground 245 "$new_ver")"
  done
  
  # Refresh waybar pacman module
  pkill -RTMIN+9 waybar
else
  echo
  gum style --foreground 226 --bold "⊘ Update cancelled"
fi

rm -f /tmp/updates.tmp
echo
read -p "Press enter to close..."
